name: Publish Calendar Release

on:
  release:
    types: [ published ]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Optional tag to use when dispatching manually (format YYYY.MM.PATCH)'
        required: false

jobs:
  publish:
    name: Publish NuGet Packages
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code (full history for versioning)
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Resolve and validate tag (YYYY.MM.PATCH expected)
      run: |
        RELEASE_TAG='${{ github.event.release.tag_name }}'
        INPUT_TAG='${{ github.event.inputs.tag }}'
        echo "Release tag from event: '$RELEASE_TAG'"
        echo "Input tag: '$INPUT_TAG'"
        if [ -n "$RELEASE_TAG" ]; then
          TAG="$RELEASE_TAG"
        elif [ -n "$INPUT_TAG" ]; then
          TAG="$INPUT_TAG"
        else
          echo "No tag provided. This workflow must be triggered by a release or run manually with the 'tag' input."
          exit 1
        fi
        echo "Validating tag format: $TAG"
        if [[ ! $TAG =~ ^[0-9]{4}\.[0-9]{1,2}\.[0-9]+$ ]]; then
          echo "Invalid tag format: $TAG. Expected format: YYYY.MM.PATCH (e.g. 2025.11.0)"
          exit 1
        fi
        echo "TAG=$TAG" >> $GITHUB_ENV

    - name: Setup .NET 10
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Install GitVersion (for metadata only)
      run: dotnet tool install --global GitVersion.Tool || echo "GitVersion already installed"

    - name: Restore dependencies
      run: dotnet restore ./src/Functional.sln

    - name: Build
      run: dotnet build ./src/Functional.sln --no-restore --configuration Release

    - name: Test
      run: dotnet test ./src/Functional.sln --no-build --configuration Release --logger trx

    - name: Compute GitVersion (informational)
      env:
        PATH: $PATH:/home/runner/.dotnet/tools
      run: |
        dotnet-gitversion /output json > gitversion.json || echo "GitVersion failed"
        echo "GitVersion output:" && cat gitversion.json || true
        echo "TAG_VERSION=${{ github.event.release.tag_name }}" >> $GITHUB_ENV

    - name: Generate Release Notes
      id: notes
      run: |
        echo "Generating release notes from previous tag to ${{ github.event.release.tag_name }}"
        CURRENT_TAG="${{ github.event.release.tag_name }}"
        # Get previous tag (second most recent) if exists
        PREV_TAG=$(git tag --sort=-creatordate | sed -n '2p') || true
        if [ -z "$PREV_TAG" ]; then
          echo "No previous tag found, using initial commit"
          RANGE="$(git rev-list --max-parents=0 HEAD)..$CURRENT_TAG"
        else
          RANGE="$PREV_TAG..$CURRENT_TAG"
        fi
        echo "Range: $RANGE"
        COMMITS=$(git log --pretty=format:'%h%x09%s%x09%an' $RANGE || true)
        # Categorize commits
        FEAT=$(echo "$COMMITS" | grep -i '^.*\tfeat' || true)
        FIX=$(echo "$COMMITS" | grep -i '^.*\tfix' || true)
        DOCS=$(echo "$COMMITS" | grep -i '^.*\tdocs' || true)
        REFACTOR=$(echo "$COMMITS" | grep -i '^.*\trefactor' || true)
        TESTS=$(echo "$COMMITS" | grep -i '^.*\ttest' || true)
        OTHER=$(echo "$COMMITS" | grep -viE '\t(feat|fix|docs|refactor|test)' || true)
        {
          echo "changelog<<EOF"
          echo "# Release $CURRENT_TAG"
          echo ""
          if [ -n "$FEAT" ]; then
            echo "## Features"; echo "$FEAT" | sed 's/^/ - /'; echo ""; fi
          if [ -n "$FIX" ]; then
            echo "## Fixes"; echo "$FIX" | sed 's/^/ - /'; echo ""; fi
          if [ -n "$DOCS" ]; then
            echo "## Docs"; echo "$DOCS" | sed 's/^/ - /'; echo ""; fi
          if [ -n "$REFACTOR" ]; then
            echo "## Refactors"; echo "$REFACTOR" | sed 's/^/ - /'; echo ""; fi
          if [ -n "$TESTS" ]; then
            echo "## Tests"; echo "$TESTS" | sed 's/^/ - /'; echo ""; fi
          if [ -n "$OTHER" ]; then
            echo "## Other"; echo "$OTHER" | sed 's/^/ - /'; echo ""; fi
          echo "Generated automatically on $(date -u '+%Y-%m-%d %H:%M UTC')"
          echo "EOF"
        } >> $GITHUB_OUTPUT
        echo "Release notes generated"

    - name: Pack NuGet packages (calendar version)
      run: |
        TAG="$TAG"
        echo "Packing packages with version: $TAG"
        dotnet pack ./src/Functional.sln --configuration Release --no-build --output ./nupkg \
          /p:Version=$TAG /p:PackageVersion=$TAG /p:ContinuousIntegrationBuild=true

    - name: Push to NuGet
      run: dotnet nuget push ./nupkg/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate

    - name: Attach Packages to Release
      uses: softprops/action-gh-release@v1
      if: github.event_name == 'release'
      with:
        files: ./nupkg/*.nupkg
        body: ${{ steps.notes.outputs.changelog }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
